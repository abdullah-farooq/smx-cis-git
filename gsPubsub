HOME=/home/ubuntu/smx-cis-git
cd $HOME
root_project=smx-gcloud-cis
command_topic=smx-command
command_subscription=smx-command-subscription
log_topic=log-aggregation
root_report=smx-cis-reports
root_bucket=smx-cis-root

dtfile=$(date '+%Y%m%d%H%M%S')
mkdir -p $HOME/locks

while true; do
 while true; do
  message=$(gcloud pubsub subscriptions pull --project $root_project --auto-ack $command_subscription --format="json(message.attributes, message.messageId, message.publishTime)")
  [ "$message" != "[]" ] || break
  mkdir -p $HOME/messages
  echo $message > $HOME/messages/$dtfile.json
  /usr/bin/flock -n $HOME/locks/gsProcessMessage.lockfile $HOME/gsProcessMessage
 done
 sleep $[ ( $RANDOM % 70 )  + 50 ]s
done
